---
import Loading from "../components/Loading.astro";
import { supabase } from "../lib/supabase";

let data = null;
let errorMsg = null;

try {
  const { data: companyData, error } = await supabase
    .from("company_info")
    .select("*")
    .single();

  if (error) throw error;
  data = companyData;
} catch (err) {
  errorMsg = err instanceof Error ? err.message : "Error desconocido";
  console.error("Error fetching company info:", errorMsg);
}
---

<head>
  <meta charset="utf-8" />
  <title>Login - {data?.nombre || "Sistema"}</title>
  <link rel="icon" href={data?.logo || "/favicon.svg"} type="image/png" />
</head>

<main class="login-container">
  <form method="POST" action="/api/login" class="login-card" id="loginForm">
    <h1>Iniciar Sesi칩n</h1>

    <label>
      Usuario o Email
      <input name="identifier" type="text" required />
    </label>

    <label>
      Contrase침a
      <input type="password" name="password" required />
    </label>

    <button type="submit">Entrar</button>
    <a class="salirlog" href="/" aria-describedby="salir-desc">Salir</a>
    <span id="salir-desc" class="sr-only">
      Vuelve a la p치gina principal sin iniciar sesi칩n
    </span>
  </form>

  <div id="loading" style="display: none;">
    <Loading />
  </div>
</main>

<script>
  const form = document.getElementById("loginForm") as HTMLFormElement;
  const loadingDiv = document.getElementById("loading") as HTMLDivElement;

  if (form && loadingDiv) {
    form.addEventListener("submit", function (event) {
      // Show loading
      loadingDiv.style.display = "block";
      // Optionally hide the form
      form.style.display = "none";
    });
  }
</script>

<style>
  .login-container {
    min-height: 80vh;
    display: grid;
    place-items: center;
    font-family: system-ui;
  }

  .login-card {
    width: 100%;
    max-width: 380px;
    padding: 2rem;
    border-radius: 14px;
    background: #fff;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
  }

  h1 {
    text-align: center;
  }

  label {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }

  input {
    padding: 0.7rem;
    border-radius: 8px;
    border: 1px solid #ccc;
  }

  button {
    margin-top: 0.5rem;
    padding: 0.8rem;
    border: none;
    border-radius: 10px;
    background: #000;
    color: #fff;
    font-weight: bold;
    cursor: pointer;
  }

  .salirlog {
    color: #000;
    text-decoration: none;
    text-align: center;
  }

  .salirlog:hover {
    text-decoration: underline;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
</style>
