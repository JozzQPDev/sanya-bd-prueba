---
import { supabase } from "../lib/supabase";

let errorMsg = "";

if (Astro.request.method === "POST") {
  const form = await Astro.request.formData();
  const email = form.get("email")?.toString();
  const password = form.get("password")?.toString();
  const username = form.get("username")?.toString();

  if (!email || !password || !username) {
    errorMsg = "Completa todos los campos";
  } else {
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
    });

    if (error) {
      errorMsg = error.message;
    } else {
      // Guardar usuario en tabla profiles
      await supabase.from("profiles").insert({
        id: data.user?.id,
        email,
        username,
      });

      return Astro.redirect("/login");
    }
  }
}
---
<form method="POST">
  <h1>Registro</h1>

  <input name="username" placeholder="Usuario" required />
  <input name="email" type="email" placeholder="Correo" required />
  <input name="password" type="password" placeholder="ContraseÃ±a" required />

  <button>Registrarse</button>

  {errorMsg && <p style="color:red">{errorMsg}</p>}
</form>
